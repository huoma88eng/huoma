<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
                // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
        // 从URL获取短代码
        function getShortCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('code') || '';
        }
        
        // 验证URL格式并添加协议
        function validateUrl(url) {
            if (!url) return '';
            // 检查是否已包含协议
            if (!/^https?:\/\//i.test(url)) {
                return 'http://' + url;
            }
            return url;
        }
        // 跳转到目标URL
        function redirectToTarget(url) {
            if (url) {
                window.location.href = url;
            }
        }
        // 初始化页面
        async function init() {
            const shortCode = getShortCode();
            
            // 如果没有短代码，重定向到首页
            if (!shortCode) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // 调用API获取二维码信息
                const response = await fetch('https://huoma.tappcn.xyz/api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_qrcode',
                        shortCode: shortCode
                    })
                });
                
                if (!response.ok) {
                    throw new Error('未找到对应的内容');
                }
                
                const qrcode = await response.json();
                
                // 确保qrcode是一个对象
                if (typeof qrcode !== 'object' || qrcode === null) {
                    throw new Error('获取的数据格式不正确');
                }
                    // URL活码处理 - 增加多重安全检查
                    let originalUrl = '';
                    
                    // 检查是否有单个URL
                    if (typeof qrcode.original_url === 'string' && qrcode.original_url.trim() !== '') {
                        originalUrl = qrcode.original_url.trim();
                    } 
                    // 检查是否有URL数组
                    else if (Array.isArray(qrcode.original_urls) && qrcode.original_urls.length > 0) {
                        // 确保第一个元素是字符串
                        if (typeof qrcode.original_urls[0] === 'string' && qrcode.original_urls[0].trim() !== '') {
                            originalUrl = qrcode.original_urls[0].trim();
                        }
                    }
                    
                    // 验证URL有效性
                    const targetUrl = validateUrl(originalUrl);
                    if (!targetUrl) {
                        throw new Error('无效的目标URL');
                    }
                        redirectToTarget(targetUrl);
                        return;
                    // 显示跳转确认界面
                    //document.getElementById('loadingState').classList.add('hidden');
                    //document.getElementById('redirectState').classList.remove('hidden');
                    //document.getElementById('targetUrlDisplay').textContent = targetUrl;
                    
                    // 检查是否为VIP用户，如果是则直接跳转
                    if (qrcode.isVip) {
                        redirectToTarget(targetUrl);
                        return;
                    }
                    
                    // 绑定继续访问按钮事件
                    document.getElementById('continueBtn').addEventListener('click', () => {
                        redirectToTarget(targetUrl);
                    });
                
                
            } catch (error) {
                // 显示错误信息
                // document.getElementById('loadingState').classList.add('hidden');
                // document.getElementById('errorState').classList.remove('hidden');
                // document.getElementById('errorMessage').textContent = error.message;
                console.error('获取内容失败:', error);
            }
        }
        
        // 页面加载完成后初始化
       // document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
