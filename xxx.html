<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" id="favicon" href="" />
    <meta name="description" id="metaDescription" content="" />
    <title id="pageTitle">内容加载中...</title>
    <meta property="og:title" id="ogTitle" content="" />
    <meta property="og:description" id="ogDescription" content="" />
    <meta property="og:image" id="ogImage" content="" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .loader {
                @apply animate-spin h-12 w-12 border-2 border-green-500 border-t-transparent rounded-full;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            .env-badge {
                @apply absolute top-2 right-2 px-2 py-1 text-xs rounded-full font-medium;
            }
        }
    </style>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        #contentFrame {
            height: 100vh;
            width: 100vw;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 加载状态 -->
    <div id="loaderContainer" class="fixed inset-0 flex flex-col justify-center items-center bg-white z-50">
        <div class="loader mb-4"></div>
        <h1 class="text-xl font-semibold text-gray-800">正在加载内容...</h1>
        <p id="loadProgress" class="text-gray-500 mt-2 text-sm">准备请求资源</p>
    </div>
    
    <!-- 内容容器 -->
    <div id="contentContainer" class="hidden fade-in">
        <!-- 防红方式控制栏 -->
        <div id="controlBar" class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-sm shadow-md z-40 p-2 flex justify-between items-center">
            <div class="text-sm font-medium text-gray-700" id="controlTitle">加载完成</div>
            <div class="flex gap-2">
                <button id="refreshBtn" class="p-2 rounded-full hover:bg-gray-100 text-gray-600" title="刷新内容">
                    <i class="fa fa-refresh"></i>
                </button>
                <button id="openBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm transition-colors">
                    <i class="fa fa-external-link mr-1"></i> 新窗口打开
                </button>
            </div>
        </div>
        
        <iframe id="contentFrame" class="border-0 pt-14" 
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                title="内嵌网页内容"></iframe>
    </div>
    
    <!-- 错误信息（含环境不匹配提示） -->
    <div id="errorContainer" class="hidden fixed inset-0 flex flex-col justify-center items-center bg-white z-50 p-6 text-center">
        <i id="errorIcon" class="fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">访问受限</h3>
        <p id="errorMessage" class="text-gray-500 mb-6">该链接不支持当前环境，请在指定应用中打开</p>
        <div id="envMismatchHint" class="hidden mb-6 p-4 bg-blue-50 border border-blue-100 rounded-lg">
            <p class="text-sm text-blue-700"><i class="fa fa-info-circle mr-1"></i> 此链接仅支持 <span id="supportedEnv" class="font-medium"></span> 环境</p>
        </div>
        <button id="retryBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
            重试
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></script>
    <script>
        // 存储当前内容信息
        let currentContent = {
            url: '',
            title: '',
            method: 'embed',
            service: 'wechat' // 新增：链接对应的服务类型（wechat/qq等）
        };
        
        // 1. 检测当前访问环境（核心功能）
        function detectCurrentEnv() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('micromessenger')) {
                return 'wechat'; // 微信环境
            } else if (userAgent.includes('qq/')) {
                return 'qq'; // QQ环境
            } else {
                return 'other'; // 其他环境（浏览器等）
            }
        }
        
        // 2. 从URL中提取ID参数
        function extractIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            
            if (!id) {
                const pathMatch = window.location.href.match(/id=(\d+)|(\d+)(?=\.\w+$)/);
                if (pathMatch) {
                    id = pathMatch[1] || pathMatch[2];
                }
            }
            
            return id ? parseInt(id, 10) : null;
        }
        
        // 3. 更新页面元数据和标题信息
        function updatePageMetadata(data) {
            // 更新标题
            const pageTitle = data.title || '内容加载中...';
            document.getElementById('pageTitle').textContent = pageTitle;
            document.getElementById('ogTitle').content = pageTitle;
            
            // 更新描述
            const description = data.subtitle || '正在加载内容...';
            document.getElementById('metaDescription').content = description;
            document.getElementById('ogDescription').content = description;
            
            // 更新封面图片
            if (data.cover_image) {
                document.getElementById('ogImage').content = data.cover_image;
                document.getElementById('favicon').href = data.cover_image;
            }
            
            // 更新控制栏标题
            document.getElementById('controlTitle').textContent = pageTitle;
        }
        
        // 4. 更新加载进度提示
        function updateLoadProgress(message) {
            document.getElementById('loadProgress').textContent = message;
        }
        
        // 5. 处理不同的防红方式
        function handleAntiBlockMethod(method, url) {
            switch(method) {
                case 'redirect':
                    // 引导跳转方式 - 显示遮罩提示
                    updateLoadProgress('准备跳转...');
                    setTimeout(() => {
                        window.open(url, '_blank');
                        document.getElementById('contentContainer').classList.remove('hidden');
                        document.getElementById('loaderContainer').classList.add('hidden');
                        alert('已尝试在新窗口打开链接，如未弹出请检查浏览器设置');
                    }, 1500);
                    return false; // 不使用iframe加载
                    
                case 'embed':
                default:
                    // 内嵌方式 - 使用iframe加载
                    return url;
            }
        }
        
        // 6. 核心：验证环境与服务类型是否匹配
        function validateEnvAndService(currentEnv, service) {
            // 服务类型与环境的映射关系（仅允许匹配的环境访问）
            const envMap = {
                'wechat': ['wechat'], // 微信防红链接仅允许微信环境
                'qq': ['qq'],         // QQ防红链接仅允许QQ环境
                'alipay': ['alipay'], // 支付宝防红链接仅允许支付宝环境
                'douyin': ['douyin']  // 抖音防红链接仅允许抖音环境
            };
            
            // 如果是其他环境（浏览器等），默认允许访问（可选）
            if (currentEnv === 'other') {
                return true;
            }
            
            // 检查当前环境是否在允许的列表中
            return envMap[service]?.includes(currentEnv) || false;
        }
        
        // 7. 从API获取URL并加载内容（新增环境验证逻辑）
        async function loadContent() {
            const id = extractIdFromUrl();
            const loaderContainer = document.getElementById('loaderContainer');
            const contentContainer = document.getElementById('contentContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const errorIcon = document.getElementById('errorIcon');
            const envMismatchHint = document.getElementById('envMismatchHint');
            const supportedEnvEl = document.getElementById('supportedEnv');
            const contentFrame = document.getElementById('contentFrame');
            
            // 显示加载状态
            loaderContainer.classList.remove('hidden');
            contentContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            envMismatchHint.classList.add('hidden'); // 隐藏环境不匹配提示
            
            if (!id) {
                setTimeout(() => {
                    loaderContainer.classList.add('hidden');
                    errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                    errorMessage.textContent = '未找到有效的ID参数，请检查链接是否正确';
                    errorContainer.classList.remove('hidden');
                }, 500);
                return;
            }
            
            try {
                // 检测当前访问环境
                const currentEnv = detectCurrentEnv();
                updateLoadProgress(`检测到环境: ${getEnvName(currentEnv)}`);
                
                // 调用API获取链接信息（包含服务类型）
                updateLoadProgress('正在请求资源信息...');
                const apiUrl = `https://wxurl.qihaobao.com/api.php?action=get_url&id=${id}`;
                
                // 设置超时时间
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('连接超时')), 10000)
                );
                
                const response = await Promise.race([
                    fetch(apiUrl),
                    timeoutPromise
                ]);
                
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status}`);
                }
                
                const result = await response.json();
                
                // 处理API响应
                if (!result.success || !result.data?.original_url) {
                    throw new Error(result.message || '未找到对应的内容');
                }
                
                // 存储内容信息（包含服务类型）
                currentContent = {
                    url: result.data.original_url,
                    title: result.data.title || '',
                    method: result.data.method || 'embed',
                    service: result.data.service || 'wechat' // 关键：获取链接对应的服务类型
                };
                
                // 验证环境与服务类型是否匹配（核心控制逻辑）
                const isEnvValid = validateEnvAndService(currentEnv, currentContent.service);
                if (!isEnvValid) {
                    // 环境不匹配，显示受限提示
                    throw new Error('environment_mismatch'); // 特殊错误标识
                }
                
                // 检查链接是否过期（基于之前优化的API）
                if (result.data.validity?.is_expired) {
                    throw new Error(`链接已过期（有效期至: ${result.data.expiry_time}）`);
                }
                
                // 更新页面元数据
                updatePageMetadata(result.data);
                
                // 处理防红方式
                updateLoadProgress('正在处理内容...');
                const frameUrl = handleAntiBlockMethod(currentContent.method, currentContent.url);
                
                // 如果需要使用iframe加载
                if (frameUrl) {
                    // 等待iframe加载完成
                    await new Promise((resolve, reject) => {
                        const iframeTimeout = setTimeout(() => {
                            reject(new Error('内容加载超时'));
                        }, 15000);
                        
                        contentFrame.onload = () => {
                            clearTimeout(iframeTimeout);
                            resolve();
                        };
                        
                        contentFrame.onerror = () => {
                            clearTimeout(iframeTimeout);
                            reject(new Error('内容加载失败'));
                        };
                        
                        // 设置iframe源
                        contentFrame.src = frameUrl;
                        updateLoadProgress('正在加载内容...');
                    });
                    
                    // 加载成功，显示内容
                    loaderContainer.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('加载失败:', error);
                loaderContainer.classList.add('hidden');
                
                // 处理环境不匹配的特殊情况
                if (error.message === 'environment_mismatch') {
                    errorIcon.className = 'fa fa-ban text-red-500 text-5xl mb-4';
                    errorMessage.textContent = '该链接不支持当前环境';
                    // 显示支持的环境提示
                    envMismatchHint.classList.remove('hidden');
                    supportedEnvEl.textContent = getEnvName(currentContent.service);
                    errorContainer.classList.remove('hidden');
                    return;
                }
                
                // 处理其他错误
                let errorText;
                if (error.message.includes('超时')) {
                    errorText = '操作超时，请检查网络连接或稍后重试';
                } else if (error.message.includes('未找到')) {
                    errorText = `未找到ID为 ${id} 的内容`;
                } else if (error.message.includes('权限')) {
                    errorText = '您没有访问该内容的权限，请开通会员后重试';
                } else if (error.message.includes('过期')) {
                    errorText = error.message;
                } else {
                    errorText = `加载失败: ${error.message}`;
                }
                
                errorIcon.className = 'fa fa-exclamation-triangle text-yellow-500 text-5xl mb-4';
                errorMessage.textContent = errorText;
                errorContainer.classList.remove('hidden');
            }
        }
        
        // 辅助函数：将环境标识转换为中文名称
        function getEnvName(env) {
            const envNames = {
                'wechat': '微信',
                'qq': 'QQ',
                'alipay': '支付宝',
                'douyin': '抖音',
                'other': '外部浏览器'
            };
            return envNames[env] || '未知环境';
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载内容
            loadContent();
            
            // 事件监听
            document.getElementById('retryBtn').addEventListener('click', loadContent);
            document.getElementById('refreshBtn').addEventListener('click', loadContent);
            
            // 新窗口打开按钮
            document.getElementById('openBtn').addEventListener('click', () => {
                if (currentContent.url) {
                    window.open(currentContent.url, '_blank');
                }
            });
        });
    </script>
</body>
</html>
